# 1co926 - 要件定義（MVP）

目的  
- クロスプラットフォーム（iOS / Android）ネイティブアプリの MVP を作る。  
- 地図上に訪問先を表示し、ユーザーが「訪問した結果」を記録できる。  
- 管理ユーザーは地点の追加・削除・編集ができる。  
- 認証はメール／パスワード方式。オフラインは初期フェーズでは不要。  
- 小規模（ユーザー <= 50）、個人開発前提。

主要仕様（確定事項）
- プラットフォーム：iOS / Android（Expo-managed React Native を推奨）  
- 認証：Firebase Authentication（メール／パスワード）  
- バックエンド：Firebase Firestore（データ保存）、Firebase Storage（写真を使う場合）  
- 地図プロバイダ：無料を優先（推奨：MapLibre + OpenStreetMap タイル）。react-native-maps でも可だが MapLibre は無料で制限が少ない。  
- ユーザー数想定：<= 50（スケーラビリティ要件は低）  
- データの永続性：Firestore（定期バックアップは推奨）  
- 開発体制：個人（将来的に Web 管理 UI を追加）

データモデル（Firestore）
- コレクション: locations (地点)
  - ドキュメントID: string（インポート元の ID を利用する / 固有 ID）
  - fields:
    - id: string (冗長に格納 可)
    - name: string
    - description: string (optional)
    - lat: number
    - lng: number
    - category: string (optional)
    - source: string (e.g., "imported" | "manual")
    - createdBy: string (uid of creator, optional)
    - createdAt: timestamp
    - properties: map/object (原データの任意プロパティ)
- コレクション: visits (訪問記録)
  - ドキュメントID: autogenerated
  - fields:
    - userId: string (uid) — 必須
    - locationId: string — 必須（locations ドキュメントの ID）
    - result: string (enum) — 必須。例: "OK" | "NG" | "NOT_APPLICABLE"（boolean ではなく enum）
    - timestamp: timestamp — 必須（訪問時刻）
    - note: string (optional)
    - photoUrl: string (optional, Firebase Storage の公開 URL)
    - createdAt: timestamp (serverTimestamp)
- コレクション: users (optional for profile / role info)
  - uid ドキュメント
    - displayName, email, role: string ("user" | "admin")（role は custom claim とは別に参照用としても保存可能）

業務ルール（ビヘイビア）
- 1 回の訪問が 1 レコード（visit）になる（履歴を保持する）。  
- 同一ユーザーが同一地点に複数回訪問した場合は複数レコードを許容する（履歴として残る）。  
- 管理ユーザーは locations の CRUD と visits の削除権限を持つ。通常ユーザーは自分の visits の作成・更新・削除（編集は可／不可は後述のルール次第）を行える。  
- 最初の実装では訪問の削除は可能にしておく（UI で編集・取り消しを実装）。

認可 / セキュリティ（概要）
- Firestore セキュリティルール（概念）
  - 認証済みユーザーは locations の read を許可（全体閲覧）。write は管理者のみ。  
  - visits の create：認証ユーザーなら可。ただし userId は認証ユーザーの uid と一致することを強制。  
  - visits の read：認証ユーザーは全体の read を許可（アプリ内で地図上に他ユーザーの訪問を表示する場合）。必要なら自分の訪問のみ閲覧制限に変更可能。  
  - visits の delete / update：管理者はすべて可能、一般ユーザーは自分の visit のみ編集・削除可能（要検討）。  
- 管理者判定：初期は Firebase Console で手動で custom claim をセットする運用（admin=true）。将来は管理 UI で割り当て可能にする。

機能（画面とフロー）
1. 認証
   - ログイン（メール／パスワード）
   - 新規登録（メール確認は任意／推奨）
   - パスワードリセット
2. メイン（地図）画面
   - 地図に locations をマーカー表示
   - マーカータップで簡易ポップアップ（名称／簡易情報）＋詳細画面遷移
   - 現在地表示（必要なら）
   - 検索/フィルタ（簡易、優先度低）
3. 場所詳細モーダル
   - 詳細情報表示
   - 「訪問記録を作成」ボタン（ポップアップで result を選ぶ（enum）、任意でメモ／写真）
4. 訪問記録入力
   - 結果を enum で選択（例: OK/NG/NOT_APPLICABLE）
   - （オプション）メモ入力、写真添付（写真は Storage に upload して photoUrl を visits に保存）
   - 保存 → visits コレクションに新規ドキュメント作成
5. 管理者画面（アプリ内／将来は Web）
   - locations の追加（地図上でタップして追加）、編集、削除
   - visits の削除（必要に応じて）
   - 管理者機能は admin role を持つユーザーのみ表示／有効

非機能要件
- 同時接続少数のためパフォーマンス要求は低。Firestore のデータモデルとインデックスを適切に設計すれば問題なし。  
- セキュリティは最小限のルールを適用（認証必須、writes は制限）。  
- バックアップ：定期的に Firestore export を行う（GCS バケットへ、cron ないし手動）。  
- ロギング／エラー収集：最初はコンソール出力・Sentry 等は任意（後で導入可）。

受け入れ基準（MVP）
- ユーザーがメール／パスワードで登録・ログインできる。  
- 地図上に locations が表示される（KMZ→GeoJSON 経由の地点も含む）。  
- ユーザーは任意の地点について 1 回の訪問を「result（enum）」として記録できる。記録は Firestore に保存される。  
- 管理ユーザーは地点の追加・削除ができる（アプリ内でまたは Firebase Console）。  
- visits は履歴として保存され、一覧や地図で確認できる。

将来機能（優先度順）
1. Web 管理 UI（地点の一括編集、ユーザー管理、CSV インポート/エクスポート）  
2. 写真アップロード対応（Storage 連携）  
3. 詳細な検索・フィルタ（期間、ユーザー、結果で絞込）  
4. オフライン対応（Firestore のローカル persistence を活用）  
5. 自動インポートのスケジューリング（Cloud Run / Cloud Scheduler）

マイルストーン（開発ステップ）
フェーズ 0（準備）— 完了済み
- リポジトリ整備、KMZ→GeoJSON と import スクリプトのベース

フェーズ 1（バックエンド・インポート安定化）
- GeoJSON スキーマ確定、import スクリプト完成、Firestore モデル作成、ルール草案作成

フェーズ 2（モバイル MVP 実装）
- Expo プロジェクト作成、Auth 実装、地図画面＋マーカー表示、visit 登録機能、管理者 UI（最低限）

フェーズ 3（運用整備）
- セキュリティルール確定、バックアップ設定、EAS/ビルド公開、テスト配布／公開

見積り（目安）
- フェーズ1: 1–3日（既存スクリプトがあるため短縮）  
- フェーズ2: 3–7日（地図表示・Auth・visit 入力・管理機能のベース）  
- フェーズ3: 1–3日（ルール整備・バックアップ・ビルド）  
※ 個人開発かつ要件精緻化次第で前後します。時間制限は無いとのことなので、品質を重視して段階的に進めることを推奨。

次の具体的アクション（推奨・短期）
1. Firestore スキーマをリポジトリにドキュメント化（このファイルを docs に追加済）。  
2. Firestore セキュリティルールの草案作成 → テスト。  
3. Expo プロジェクト scaffold をリポジトリ内に追加（mobile/）し、最小で Auth + locations の読み取り表示を実装。  
4. visits 作成フロー（enum の選択UI）を実装し、データ保存を確認。  
5. 管理者用の簡易 UI（モバイル内）で locations の追加・削除を実装。

補足（決めごとの要約）
- visit.result は enum（例: "OK" / "NG" / "N/A"）  
- 1 回の訪問 = 1 レコード（履歴を残す）  
- Web 管理 UI は将来作成する（当面はアプリ内管理者機能 or Firebase Console で対応）  
- Map provider は無料の MapLibre + OSM を推奨（Expo + 組み合わせ可）

---

編集・承認依頼  
この要件定義に問題がなければ「承認」と返してください（次は Firestore スキーマの JSON 例、セキュリティルール草案、あるいは Expo scaffold のどれを先に作るか指示をください）。  
修正希望があれば変更点を教えてください。  
